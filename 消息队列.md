# 消息队列

## 1.为什么需要消息队列

消息队列：**解耦、异步、削峰**

异步：缩短主流程、异步处理

解耦：新增新的服务，发送到对应的主题就行

削峰：消息的暂存，系统慢慢处理

## 2.MQ的选择

RabbitMQ：轻量级、开箱即用，性能较差、消息堆积不好

Kafka：日志系统、大型公司、分布式非常高效，同步的场景不太适合，主题多吞吐量下降

RocketMQ：响应延时低

## 3.MQ消息可靠性

### 3.1 通过MQ机制

Rocketmq和KafKa类似（实质上，最早的Rocketmq 就是KafKa 的Java版本），一条消息从生产到被消费，将会经历三个阶段：

- 生产阶段，Producer 新建消息，而后经过网络将消息投递给 MQ Broker。这个发送可能会发生丢失，比如网络延迟不可达等。
- 存储阶段，消息将会存储在 Broker 端磁盘中，Broker 根据刷盘策略持久化到硬盘中，刚收到Producer的消息在内存中了，但是如果Broker 异常宕机了，导致消息丢失。
- 消费阶段， Consumer 将会从 Broker 拉取消息

#### 生产阶段

**同步发送:**发消息的时候会同步阻塞等待broker返回的结果，如果没成功，则不会收到SendResult，这种是最可靠的。

**异步发送:**RabbitMQ提供了消息确认机制，即生产者在发送消息后，**可以等待RabbitMQ服务器返回确认信息**，以确保消息已经被正确地接收和处理。如果RabbitMQ服务器没有返回确认信息，生产者可以选择重新发送消息或者采取其他的补救措施。

生产端的失败重试策略，设置重试次数

#### 存储阶段

消息持久化：RabbitMQ支持将消息持久化到磁盘，即使RabbitMQ服务器岩机或重启，消息也不会丢失。在发布消息时，可以设置消息的持久化标志，这样消息就会被写入磁盘中，而不是仅仅保存在内存中。

同步刷盘指的是：生产者消息发过来时，只有持久化到磁盘，RocketMQ、kafka的存储端Broker才返回一个成功的ACK响应，这就是同步刷盘。它保证消息不丢失，但是影响了性能。

异步刷盘指的是：消息写入PageCache缓存，就返回一个成功的ACK响应，不管消息有没有落盘，就返回一个成功的ACK响应。这样提高了MQ的性能，但是如果这时候机器断电了，就会丢失消息。

可以在消息持久化磁盘后，再给生产者发送一个Ack信号

1. 将queue的持久化标识durable设置为true,则代表是一个持久的队列
2. 发送消息的时候将deliveryMode=2

#### **消费阶段**

RabbitMQ提供了消息确认机制，即生产者在发送消息后，可以等待RabbitMQ服务器返回确认信息，以确保消息已经被正确地接收和处理。如果RabbitMQ服务器没有返回确认信息，生产者可以选择重新发送消息或者采取其他的补救措施。

同步消费场景，业务代码手动发送CONSUME_SUCCESS ，保证 消息者的0丢失

异步消费场景，需要通过业务维度的 终极0丢失保护措施：本地消息表+定时扫描 ，保证 消息者的0丢失

#### 消息重试机制

如果消息在传输过程中出现异常，RabbitMQ会自动进行消息重试，直到消息被正确地处理为止。可以通过设置重试次数和重试时间间隔来控制消息重试的行为。

达到重复机制的上限之后进入死信队列中等待消费

### 3.2 本地消息表+定时任务

1、设计一个本地消息表，可以存储在DB里，或者其它存储引擎里，用户保存消息的消费状态

2、Producer 发送消息之前，首先保证消息的发生状态，并且初始化为待发送；

3、如果消费者（如库存服务）完成的消费，则通过RPC，调用Producer 去更新一下消息状态；

- 先去查表

4、Producer 利用定时任务扫描 过期的消息（比如10分钟到期），再次进行发送。

1、设计一个本地消息表，可以存储在DB里，或者其它存储引擎里，用户保存消息的消费状态

2、Producer 发送消息之前，首先保证消息的发生状态，并且初始化为待发送；

3、如果消费者（如库存服务）完成的消费，则通过RPC，调用Producer 去更新一下消息状态；

4、Producer 利用定时任务扫描 过期的消息（比如10分钟到期），再次进行发送。

<img src="https://mmbiz.qpic.cn/sz_mmbiz_png/xlgvgPaib7WO8Tic04SfDar9dQ7xVI7b3DbSgVBBzyLIiam49k9xNyJf4CKnibibiaicd00o4tKUKicNsFibp9FIcmTib8NA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片" style="zoom: 67%;" />

## 4. MQ一定可以消费

分布式锁：一锁二判三更新

<img src="https://i-blog.csdnimg.cn/blog_migrate/82c2bd006f1b130d9be18d34db4309a7.png" alt="在这里插入图片描述" style="zoom:67%;" />                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
